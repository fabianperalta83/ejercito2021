<?php
/**********************************************************/
/* Formulario de ingreso de solicitudes del sistema de PQR*/
/**********************************************************/
//ini_set("display_errors",1);

/** SOLICITUD DE ARCHIVOS REQUERIDOS **/

require_once (_DIRCORE. 'Validacion.class.php');
require_once (_DIRCORE. 'Autenticacion.class.php');
require_once (_DIRCORE. 'Funciones.class.php');
require_once (_DIRLIB. 'pqr/FuncionesPQR.php');
require_once (_DIRLIB. 'smarty/libs/Smarty.class.php');
require_once (_DIRLIB. 'pqr/Transaccion.class.php');
require_once (_DIRLIB. 'pqr/Solicitud.class.php');
require_once (_DIRLIB. 'PHPMailer_v5.1/class.phpmailer.php');

/** VARIABLES GLOBALES **/

/* Hace disponible la conexiï¿½n a la base de datos */
global $db;
//$db->debug=true;
/**** CONFIGURACION DEL FORMULARIO ****/

/** DECLARACIï¿½N E INICIALIZACIï¿½N DE VARIABLES **/

/* Variable que contiene la fecha y hora de la transacciï¿½n */
$timestamp 				= date('Y-m-d H:i:s');
$mensaje = "";


/* Define el tipo de formulario que se mostrarï¿½ */
$tipo_formulario		= 'web';
$asunto_nombre			= '';
/* Define los indicadores de los tipos de documento y originadores  en la base de datos necesarios para el calculo*/
/* tipos de documento */
$nit					= 3;

/* originadores */
$persona_natural		= 3;
$persona_juridica		= 4;

/* Define el tamaï¿½o mï¿½ximo de los documentos adjuntos en bytes (1 Mbyte = 1048576 Bytes)*/
$archivo_max_size				= 3145728;
$error_envio_informacion = false;

/* Define los tipos de archivo permitidos */
$tipo_archivo_permitido 		= array (
	'image/jpg',
    'image/jpeg',
	'image/png',
	'image/gif',
	'image/pjpeg',
	'image/x-png',
    'image/tif',
    'image/tiff',
    'application/pdf',
	'application/vnd.ms-excel',
	'application/msword',
	'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
	'application/vnd.openxmlformats-officedocument.wordprocessingml.document',


	
);
/*$tipo_archivo_permitido 		= array (
	'application/msword',
	'application/pdf',
	'image/pjpeg',
	'text/richtext',
	'image/jpeg',
	'video/mpeg',
	'video/avi',
	'video/quicktime',
	'application/x-shockwave-flash',
	'image/png',
	'application/vnd.ms-excel',
	'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
	'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
	'application/vnd.ms-powerpoint',
	'application/mspowerpoint',
);*/

$dependencia_usuario 			= getVariable("dependencia_default",_PQR_ATENCION);
$sql_dependencia_usuario 		= sprintf('SELECT dependencia_nombre FROM %s WHERE dependencia_id=%s', _TBL_PQR_DEPENDENCIA,$dependencia_usuario);
$resultado_dependencia_usuario 	= $db->Execute($sql_dependencia_usuario);
$lb_dependencia_usuario 		= $resultado_dependencia_usuario->fields['dependencia_nombre'];

/* Definiciï¿½n de la profundidad de los select de ubicacion, asunto y dependencia
 * Este valor se refleja en la cantidad de selects que quedan disponibles para
 * hacer la selecciï¿½n de cada uno de estos.
 * La profundidad mï¿½xima permitida es 5.*/
$region_profundidad				=	3;
$asunto_profundidad				=	1;
$dependencia_profundidad		=	5;

/* Vï¿½nculos de administraciï¿½n */
$link_menu_administracion		=	sprintf(
										'<a href="index.php?idcategoria=%s">MEN&Uacute; DE ADMINISTRACI&Oacute;N</a>',
										_PQR_ADMINISTRACION);

					/** DECLARACIï¿½N E INICIALIZACIï¿½N DE VARIABLES **/

/* Arreglo en el cual se almacena la descripciï¿½n de los errores que se presenten en la validaciï¿½n del formulario */
$errores 			= array ();

/* Arreglo que almacena los identificadores de las solicitudes del usuario */
$solicitudes		= array();

/* Variable que almacena el cï¿½digo html que contiene las solicitudes del usuario */
$solicitudes_html	= '';

/* Variable que controla la continuidad de la transacciï¿½n */
$continuar 			= 'ok';

/* Variable que indica si el usuario es administrador del sistema */
$administrador_pqr 	= 'no';

/* Variable que indica si el usuario es digitador del sistema */
$digitador_pqr		= 'no';

/* Variable que indica si el usuario es digitador del sistema ****FP*/
$gestor_pqr		= 'no';

/* Variable que almacena el mensaje de respuesta para el usuario */
$msg_respuesta 		= '';

$flg_nueva			= false;
$nregion 			= '';
$iregion			= '';

/* Miga de la ubicaciï¿½n */
$miga_ubicacion_arreglo		=	array();
$miga_ubicacion_id_arreglo	=	array();

/* Miga del asunto */
$miga_asunto_arreglo		=	array();
$miga_asunto_id_arreglo		=	array();

/* Miga de la dependencia */
$miga_dependencia_arreglo	=	array();
$miga_dependencia_id_arreglo=	array();

/* Arreglo que almacena los nombres de los archivos adjuntados a la solicitud. */
$documento_cargado			=	array();

/* Variable que almacena el listado de documentos para enviar en el correo. */
$documentos_email			=	'';

/* Crea el valor entendible para el usuario(hr=human readable) del tamaï¿½o mï¿½ximo del archivo */
$archivo_max_size_hr		=	($archivo_max_size/1048576).' Mb';

/* Define los nombres de los input para los select dependientes, para adicionar niveles al select
 * se deben adicionar en la variable de profundidad de cada uno y en los arreglos en el archivo de
 * funciones de javascript de la aplicaciï¿½n */

for($i=0;$i<$region_profundidad;$i++){
	$select_region_nombre[$i]		=	'ubicacion_n'.($i+1);
}

for($i=0;$i<$asunto_profundidad;$i++){
	$select_asunto_nombre[$i]		=	'asunto_n'.($i+1);
}

for($i=0;$i<$dependencia_profundidad;$i++){
	$select_dependencia_nombre[$i]	=	'dependencia_n'.($i+1);
}

/* Obtiene las opciones de la base de datos que se mostraran como selects en el formulario */
$select_originador				=	genera_arreglo_select('pqr_originador'			,'originador_id'			,'originador_nombre');
$select_tipo_identificacion		=	genera_arreglo_select('pqr_tipo_identificacion'	,'tipo_identificacion_id'	,'tipo_identificacion_descripcion');
$select_tipo_solicitud			=	genera_arreglo_select('pqr_tipo'				,'tipo_id'					,'tipo_nombre');
$select_medio_recepcion			=	genera_arreglo_select('pqr_medio'				,'medio_id'					,'medio_nombre');
$select_estado					=	genera_arreglo_select('pqr_estado'				,'estado_id'				,'estado_nombre');

/* incializacion de otras variables */
$nombre			= '';
$direccion		= '';
$telefono		= '';
$email			= '';
$idusuario		= 0;
$flg_registrado = 'no';

/* Verifica si el existe un usuario autenticado en el portal */
if(isset($_SESSION['info_usuario']))
{
	$usuario_registrado	= 'ok';
//$administrador_pqr	= 'ok';
	/* verifica si el usuario es digitador del sistema pqr*/
	if(esDigitadorPqr($_SESSION['info_usuario']['idusuario']))
	{
		$digitador_pqr		= 'ok';
		$tipo_formulario	= 'digitador';
	} 

	/* Verifica si el usuario es administrador del sistema de PQR */
	if(esAdministradorPqr($_SESSION['info_usuario']['idusuario']))
	{
		$administrador_pqr	= 'ok';
	}
	/*Verifica si el usuario es Gestor del sistema**********************FP*/
 	if(esGestorPqr($_SESSION['info_usuario']['idusuario']))
	{
		$gestor_pqr	= 'ok';
	}
	else
	{
		$verifica_dependencia 	= sprintf('SELECT dependencia_id FROM %s WHERE idusuario=%s', _TBL_PQR_REL_DEPENDENCIA_USUARIO, $_SESSION['info_usuario']['idusuario']);
		$resultadoverifica		= $db->Execute($verifica_dependencia);
		if($resultadoverifica->NumRows()>0)
		{
			$flg_registrado		= 'ok';
		}
	}
}
else
{
	$usuario_registrado='no';
}

							/** DEFINICION DE LAS CARACTERISTICAS DEL TIPO DE FORMULARIO **/

/* Asigna los valores por defecto segï¿½n la configuraciï¿½n indicada
 * para el tipo de formulario y teniendo en cuenta si el usuario
 * esta validado en el portal
 */
if($usuario_registrado=='ok')
{
	if($tipo_formulario=='web')
	{

		/* Define los campos que se mostraran */
		$flg_originador_visible	= 0;
		$flg_estado	     	= 0;
		$flg_medio_recepcion	= 1;
		$flg_resumen		= 0;

	}
	elseif($tipo_formulario=='digitador')
	{
		/* Define los campos que se mostraran */
		$flg_originador_visible	= 1;
		$flg_estado				= 1;
		$flg_medio_recepcion	= 1;
		$flg_resumen			= 1;
	}
	else
	{
		/* Define los campos que se mostraran */
		$flg_originador_visible	= 0;
		$flg_estado				= 0;
		$flg_medio_recepcion	= 0;
		$flg_resumen			= 0;
	}

	/* Define los campos que aparecen desactivados segï¿½n el tipo de usuario */
	if('ok' == $administrador_pqr || 'ok' == $digitador_pqr || 'ok' == $gestor_pqr)
	{
		$flg_disabled_nombre		= 0;
		$flg_disabled_direccion		= 0;
		$flg_disabled_telefono		= 0;
		$flg_disabled_email			= 0;
		$flg_hash					= 0;
	}
	else
	{
		$flg_disabled_nombre		= 1;
		$flg_disabled_direccion		= 1;
		$flg_disabled_telefono		= 1;
		$flg_disabled_email			= 1;
		$flg_hash					= 0;
	}

	/* Valores por defecto*/
	$nombre		=	$_SESSION['info_usuario']['nombres'].' '.$_SESSION['info_usuario']['apellidos'];
	$direccion	=	$_SESSION['info_usuario']['direccion'];
	$telefono	=	$_SESSION['info_usuario']['telefono'];
	$email		=	$_SESSION['info_usuario']['email'];
	$idusuario	=	$_SESSION['info_usuario']['idusuario'];

	$medio_recepcion_default	=	5;
	$estado_default				=	1;
	$tipo_identificacion_default=	1;
	$tipo_solicitud_default		=	1;
	$tipo_documento				=	1;

	/* Consulta las solicitudes realizadas por el usuario */
	$sql_consulta_solicitudes=sprintf(
		'SELECT solicitud_id ' .
		'FROM %s ' .
		'WHERE solicitante_id in ' .
			'(SELECT solicitante_id FROM %s WHERE idusuario=%s)',
		_TBL_PQR_SOLICITUD,_TBL_PQR_SOLICITANTE,$idusuario);

	$resultado_consulta_solicitudes=$db->Execute($sql_consulta_solicitudes);
	if($resultado_consulta_solicitudes){
		while(!$resultado_consulta_solicitudes->EOF){
			array_push($solicitudes,$resultado_consulta_solicitudes->fields['solicitud_id']);
			$resultado_consulta_solicitudes->MoveNext();
		}
	}

	 /* Crea el cï¿½digo html para mostrar las solicitudes del usuario */
	
	//  $solicitudes_html	= consulta_solicitudes($solicitudes);

	
	
	 /* Limpia el arreglo que contiene las solicitudes del usuario registrado */
	//  $solicitudes = array();
}
else
{
	/* Define los campos que se mostraran si el usuario no esta registrado*/
	$flg_originador_visible			= 0;
	$flg_estado						= 0;
	$flg_medio_recepcion			= 0;
	$flg_resumen					= 0;

	/* Define los campos que aparecen desactivados */
	$flg_disabled_nombre			= 0;
	$flg_disabled_direccion			= 0;
	$flg_disabled_telefono			= 0;
	$flg_disabled_email				= 0;
	$flg_hash						= 1;

	/* Valores por defecto*/
	$medio_recepcion_default		= 5;
	$estado_default					= 1;
	$tipo_identificacion_default	= 1;
	$tipo_solicitud_default			= 1;
	$tipo_documento					= 1;
}

/* Crea el valor por defecto para el hash cuando es un usuario registrado
 * cuando es un usuario no registrado el valor del hash se genera dentro
 * del llamado a la imagen generada */
if(0 == $flg_hash)
{
	$hash_default			= strtoupper(str_replace(array('0','o','O'),'A',substr(md5(rand(0,999999)),10,6)));/**@todo revisar cual captcha se estï¿½ usando */
	$_SESSION["captcha"]	= $hash_default;
}
else
{
	$hash_default='';
}



/* Consulta la solicitud segï¿½n el hash indicado por el usuario */

							/** RECUPERA LA INFORMACIï¿½N INGRESADA POR EL USUARIO **/

/* obtiene el tipo de identificacion seleccionada por el usuario para calcular el tipo de persona */
$tipo_identificacion = getVariable('tipo_identificacion', $tipo_identificacion_default);

/* Calcula el tipo de persona segï¿½n el tipo de identificacion */
if($tipo_identificacion==$nit){
	$tipo_persona_default=$persona_juridica;
}
else{
	$tipo_persona_default=$persona_natural;
}

/* Obtiene la regiï¿½n seleccionada por el usuario*/
$numero_selects=$region_profundidad;
$region=0;

while($region==0 && $numero_selects>0){
	$region=getVariable($select_region_nombre[$numero_selects-1],0);
	$numero_selects--;
}

/* Obtiene el asunto seleccionado por el usuario */
$numero_selects=count($select_asunto_nombre);
$asunto=0;
while($asunto==0 && $numero_selects>0){
	$asunto=getVariable($select_asunto_nombre[$numero_selects-1],0);
	$numero_selects--;
}

/* Lï¿½nea agregada temporalmente para deshabilitar la selecciï¿½n del asunto cuando la solicitud es para
   derechos humanos y viene del vï¿½nculo creado para tal fin */
if(isset($_GET['asunto_n1']))
{
	$flg_disabled_select_asunto	= 1;
	$asunto_nombre	= nombre_elemento('pqr_asunto','asunto_id','asunto_nombre',$_GET['asunto_n1']);
}
else
{
	$flg_disabled_select_asunto	= 0;
}

/* Obtiene la dependencia seleccionado por el usuario */
$numero_selects=count($select_dependencia_nombre);
$dependencia=0;
while($dependencia==0 && $numero_selects>0){
	$dependencia=getVariable($select_dependencia_nombre[$numero_selects-1],$dependencia_usuario);
	$numero_selects--;
}

/* Obtiene la informaciï¿½n ingresada del formulario y le quita las etiquetas html y php que tengan*/
$nombre 					= Autenticacion::secureSQL(getVariable('nombre', $nombre),'');
$tipo_persona 				= Autenticacion::secureSQL(getVariable('tipo_persona', $tipo_persona_default),'');
$numero_identificacion 		= Autenticacion::secureSQL(getVariable('numero_identificacion', ''),'');
$digito_verificacion 		= Autenticacion::secureSQL(getVariable('digito_verificacion',''),'');
$direccion 					= Autenticacion::secureSQL(getVariable('direccion', $direccion),'');
$telefono 					= Autenticacion::secureSQL(getVariable('telefono', $telefono),'');
$celular 					= Autenticacion::secureSQL(getVariable('celular', ''),'');
$email 						= Autenticacion::secureSQL(getVariable('email', $email),'');
$estado 					= Autenticacion::secureSQL(getVariable('estado',$estado_default),'');
$medio_recepcion 			= Autenticacion::secureSQL(getVariable('medio_recepcion', $medio_recepcion_default),'');
$tipo_solicitud 			= Autenticacion::secureSQL(getVariable('tipo_solicitud', 0),'');
$solicitud 					= Autenticacion::secureSQL(getVariable('solicitud',''),'');
$resumen 					= Autenticacion::secureSQL(getVariable('resumen', $solicitud),'');
$hash 						= Autenticacion::secureSQL(getVariable('hash', $hash_default),'');
$tipo_documento 			= Autenticacion::secureSQL(getVariable('tipo_documento', $tipo_documento),'');	//Aun no se ha implementado la captura de esta informaciï¿½n
$consulta_hash 				= Autenticacion::secureSQL(getVariable('consulta_hash', ''),'');
$ver_solicitudes 			= Autenticacion::secureSQL(getVariable('ver_solicitudes',0),'');


if($tipo_solicitud <= 0)
{
	$tipo_solicitud	= $tipo_solicitud_default;
}
if($medio_recepcion <= 0)
{
	$medio_recepcion = $medio_recepcion_default;
}
if($estado <= 0)
{
	$estado = $estado_default;
}

/* indica si el textbox del digito de verificacion debe iniciar visible */
if($tipo_identificacion == $nit){
	$digito_verificacion_visibility	= 'visible';
}
else
{
	$digito_verificacion_visibility	= 'hidden';
}

/* Verifica si se enviï¿½ el formulario de creaciï¿½n de solicitud */

if (count($_POST) > 0)
{
	$enviar 			= 'ok';

	/* Desactiva la opciï¿½n de ver la solicitudes la cual esta activa
	 * por defecto porque viene en un campo hidden del formulario */
	$ver_solicitudes	= 0;
}
else
{
	$enviar = 'no';
	/* Verifica si se envï¿½o el formulario de consulta de solicitud */
	if(isset($_POST['consulta_hash']) || isset($_GET['consulta_hash']))
	{
		if($consulta_hash=='' && 'no' == $usuario_registrado)
		{
			$ver_solicitudes	= 0;
		}
		else
		{
			/* Crea la sentencia de consulta */
			$sql_consulta_hash	= sprintf(
				'SELECT solicitud_id ' .
				'FROM %s ' .
				'WHERE solicitud_hash="%s"',
				_TBL_PQR_SOLICITUD,$consulta_hash);

			/* Ejecuta la consulta */
			$resultado_consulta_hash	= $db->Execute($sql_consulta_hash);
			/* Si la solicitud existe muestra la informaciï¿½n bï¿½sica */
			if($resultado_consulta_hash && $resultado_consulta_hash->NumRows()==1)
			{
				array_push($solicitudes,$resultado_consulta_hash->fields['solicitud_id']);
				/* Crea el cï¿½digo html para mostrar las solicitudes del usuario */
				$solicitudes_html		= consulta_solicitudes1($solicitudes);
			}
			else
			{
				$solicitudes_html		= 'No existe una solicitud relacionada con ese c&oacute;digo, por favor' .
						' reviselo e intente de nuevo.';
			}
		}
	}
}



					/** OBTIENE LOS NOMBRES DESCRIPTIVOS DE LOS ELEMENTOS SELECCIONADOS POR EL USUARIO **/

/* Obtiene la miga de las regiones */
miga_recursivo($region, 'pqr_region', 'region_id', 'region_nombre', 'region_id_padre', $miga_ubicacion_arreglo);
$miga_ubicacion=formato_miga($miga_ubicacion_arreglo,' ->');

/* Obtiene la miga del asunto */
miga_recursivo($asunto, 'pqr_asunto', 'asunto_id', 'asunto_nombre', 'asunto_id_padre', $miga_asunto_arreglo);
$miga_asunto=formato_miga($miga_asunto_arreglo,' ->');

/* Obtiene la miga de la dependencia */
miga_recursivo($dependencia, 'pqr_dependencia', 'dependencia_id', 'dependencia_nombre', 'dependencia_id_padre', $miga_dependencia_arreglo);
$miga_dependencia=formato_miga($miga_dependencia_arreglo,' ->');

/* Obtiene el nombre del medio de recepcion */
$nombre_medio_recepcion=nombre_elemento('pqr_medio','medio_id','medio_nombre',$medio_recepcion,'No disponible');

/* Obtiene el nombre del tipo de solicitud */
$nombre_tipo_solicitud=nombre_elemento('pqr_tipo','tipo_id','tipo_nombre',$tipo_solicitud,'No disponible');

/* Obtiene el nombre del tipo de identificacion del usuario */
$nombre_tipo_identificacion=nombre_elemento('pqr_tipo_identificacion','tipo_identificacion_id','tipo_identificacion_descripcion',$tipo_identificacion,'No disponible');

				/** CREA LOS SELECT DEPENDIENTES USANDO EL VALOR SELECCIONADO POR EL USUARIO **/

/* Crea los select de la ubicaciï¿½n */
$cantidad_selects	= count($select_region_nombre);
$nivel				= 0;
for($i=0;$i<$cantidad_selects;$i++){
	if($i>0 && $nivel==0){
		$select_region[$i]='<select disabled="disabled" id="'.$select_region_nombre[$i].'" title="'.$select_region_nombre[$i].'">
									<option value="0">Seleccione...</option>
								</select>';
	}
	else{
		$nivel_seleccionado=getVariable($select_region_nombre[$i],0);
		$select_region[$i] = genera_select_dependiente($nivel, $select_region_nombre[$i], 'pqr_region', 'region_id', 'region_nombre', 'region_id_padre',$nivel_seleccionado);
		$nivel=$nivel_seleccionado;
	}
}

/* Crea los select del asunto */
$cantidad_selects=count($select_asunto_nombre);
$nivel=0;
for($i=0;$i<$cantidad_selects;$i++){
	if($i>0 && $nivel==0){
		$select_asunto[$i]='<select disabled="disabled" id="'.$select_asunto_nombre[$i].'" title="'.$select_asunto_nombre[$i].'">
									<option value="0">Seleccione...</option>
								</select>';
	}
	else{
		$nivel_seleccionado=getVariable($select_asunto_nombre[$i],0);
		$select_asunto[$i] = genera_select_dependiente($nivel, $select_asunto_nombre[$i], 'pqr_asunto', 'asunto_id', 'asunto_nombre', 'asunto_id_padre',$nivel_seleccionado,'asunto_descripcion');
		$nivel=$nivel_seleccionado;
	}
}

/* Crea los select de la dependencia */
$cantidad_selects=count($select_dependencia_nombre);
$nivel=0;
for($i=0;$i<$cantidad_selects;$i++){
	if($i>0 && $nivel==0){
		$select_dependencia[$i]='<select disabled="disabled" id="'.$select_dependencia_nombre[$i].'" name="'.$select_dependencia_nombre[$i].'" title="'.$select_dependencia_nombre[$i].'">
									<option value="0">Seleccione...</option>
								</select>';
	}
	else{
		$nivel_seleccionado=getVariable($select_dependencia_nombre[$i],0);
		$select_dependencia[$i] = genera_select_dependiente($nivel, $select_dependencia_nombre[$i], 'pqr_dependencia', 'dependencia_id', 'dependencia_nombre', 'dependencia_id_padre',$nivel_seleccionado);
		$nivel=$nivel_seleccionado;
	}
}

							/** VALIDACIï¿½N DE LA INFORMACIï¿½N INGRESADA POR EL USUARIO EN EL FORMULARIO **/
//codigo de farez para el certificado de los 50 anos

if($dependencia==191)
{
	$mensaje	=	"Debe anexar la fotocopia legible  de la cedula ampliada al 150% en formato PDF o JPG";
}
elseif($dependencia==192)
{
	$mensaje	=	"Debe anexar la fotocopia del certificado del CODA (Comité operativo para la dejación de las armas)";
}

/* Valida que el nombre sea texto vï¿½lido o que el campo este vacio */
if (!Validacion :: isTexto($nombre, FALSE) && !Validacion :: isEmpty($nombre)) {
	array_push($errores, 'Por favor revise el nombre, recuerde que solo debe tener letras.');
}

/* Valida que el nï¿½mero de identificaciï¿½n sea un valor numï¿½rico o que el campo este vacio */
if (!Validacion :: isNum($numero_identificacion) && !Validacion :: isEmpty($numero_identificacion)) {
	array_push($errores, 'Por favor revise el número de identificación, recuerde que solo debe tener números.');
}
/* Si se escogio NIT como tipo de identificaciï¿½n y se ingreso el nï¿½mero se valida el digito de verificacion */

if (!Validacion :: isNum($digito_verificacion) && !Validacion :: isEmpty($numero_identificacion) && $tipo_identificacion==$nit) {
	array_push($errores, 'Por favor revise el digito de verificación, debe escribir un número.');
}
/* Valida que la direcciï¿½n sea texto vï¿½lido o que el campo este vacio */
if (!Validacion :: isTexto($direccion, FALSE) && !Validacion :: isEmpty($direccion)) {
	array_push($errores, 'Por favor revise su dirección, recuerde que solo debe tener letras y números.');
}
/* Valida que el nï¿½mero telefonico este compuesto de espacios y numeros o que este vacio */
if (!Validacion :: isNumTelephone($telefono) && !Validacion :: isEmpty($telefono)) {
	array_push($errores, 'Por favor revise el número telefonico, recuerde que solo debe tener números.');
}
/* Valida que el nï¿½mero celular este compuesto de espacios y nï¿½meros o que este vacio */
if (!Validacion :: isNumTelephone($celular) && !Validacion :: isEmpty($celular)) {
	array_push($errores, 'Por favor revise el número de celular, recuerde que solo debe tener números.');
}
if (Validacion :: isEmpty($email)) {
	array_push($errores, 'Por favor ingrese una dirección de correo de uso frecuente.');
}
/* Valida que el correo electrï¿½nico tenga el formato adecuado o que este vacio */
if (!Validacion :: isEmail($email, FALSE) && !Validacion :: isEmpty($email)) {
	array_push($errores, 'Verifique la sintaxis del correo electrónico');
}
/* Valida que el campo solicitud no se encuentre vacio */
if (Validacion :: isEmpty($solicitud)) {
	array_push($errores, 'Debe escribir una solicitud');
}
/* Valida para que al momento de crear una solicitud no deje enviarla si se selecciona las dependencias COMANDO GENERAL y SEGUNDO CDTE Y JEM*/
/*if($select_dependencia_nombre == 38 ){ //or $select_dependencia_nombre == 39
   
   array_push($errores, 'Seleccione una dependencia diferente a COMANDO GENERAL');
 
}*/



/*   Capturamos los valores asignados a las dependencia que envia el usuario,
     para verificar de que no se asigne a COMANDO GENERAL ni SEGUNDO CDTE Y JEM  */


	 $dependencia1 = $_POST["dependencia_n1"];
	 $dependencia2 = $_POST["dependencia_n2"];
	 $dependencia3 = $_POST["dependencia_n3"];
	 
	 /* 
	  $dependencia4 = $_POST["dependencia_n4"];
	  $dependencia5 = $_POST["dependencia_n5"];
	 */


if($dependencia1 == 38 and $dependencia2 == 0){

   array_push($errores, 'Debe seleccionar una subdependencia de COMANDO EJÉRCITO.');
 
}
if($dependencia2 == 39 and $dependencia3 == 0){

  array_push($errores, 'Debe seleccionar una subdependencia de SEGUNDO CDTE Y JEM.');

}

/* Valida que el usuario escriba correctamente las letras de verificaciï¿½n */

if (isset ($_SESSION['captcha']))
{
    
    
    if ($hash != $_SESSION['captcha'])
	{
		array_push($errores, 'Debe escribir la palabra de la imagen para confirmar la solicitud');
                
	}
	else
	{
            
            

            /* Si ya existe una solicitud con el hash generado se genera uno nuevo y se pide al usuario que lo digite de nuevo*/
                
                for($count = 0; $count < 100; $count++){
                    
                    $sql_consulta_hash = 'select * from pqr_solicitud where solicitud_hash="' . $_SESSION['captcha'] . '"';
                    $resultado_consulta_hash = $db->Execute($sql_consulta_hash);
                    $numeroFilas = $resultado_consulta_hash->NumRows();
                    if ($numeroFilas > 0)
                    {

                            $_SESSION['captcha']         = strtoupper(str_replace(array('0','o','O'),'A',substr(md5(rand(0,99999)),10,6)));
                            $hash						= $_SESSION['captcha'];
                            $sql_consulta_hash 			= 'select * from pqr_solicitud where solicitud_hash="' . $_SESSION['captcha'] . '"';
                            $resultado_consulta_hash 	= $db->Execute($sql_consulta_hash);
                            $numeroFilas 				= $resultado_consulta_hash->NumRows();
                //array_push($errores, 'El numero de capcha ya expiro, porfavor intentelo de nuevo');
                    }else
                        break;
                }
		
		
		//$_SESSION['captcha']="";
	
	}
        
       
}

/* Valida que los archivos cargados tengan las caracteristicas de formato y tamaï¿½o correctas */
if (isset ($_FILES["archivos"]))
{
	/* Si existe el arreglo de archivos lo recorremos para obtener la informaciï¿½n de cada archivo*/
	$total_archivos = count($_FILES["archivos"]["name"]);

	//Recorre el arreglo de archivos
	for ($i = 0; $i < $total_archivos; $i++) {
		/* Obtiene la informaciï¿½n del archivo */
		$archivo_nombre 			= Autenticacion::secureSQL($_FILES["archivos"]["name"][$i],'');
		$archivo_nombre_temporal 	= $_FILES["archivos"]["tmp_name"][$i];
		$archivo_tipo 				= $_FILES["archivos"]["type"][$i];
		$archivo_error 				= $_FILES["archivos"]["error"][$i];
		$archivo_size 				= $_FILES["archivos"]["size"][$i];
         // var_dump($archivo_tipo);
		/* Vï¿½lida si el campo de carga del archivo se envio en blanco */
		if ($archivo_nombre != '') {
				/* Valida que el tamaï¿½o del archivo no supere el mï¿½ximo permitido */
			if ($archivo_size > $archivo_max_size) {
				array_push($errores, 'El archivo ' . $archivo_nombre . ' supera el tamaño límite de '.$archivo_max_size_hr);
			}

		    /*---------NUEVO--------Codigo para verificar si es imagen o no (si la extension corresponde al archivo)*/
			 if($_FILES["archivos"]["type"][$i]=="image/png" || $_FILES["archivos"]["type"][$i]=="image/jpg" || $_FILES["archivos"]["type"][$i]=="image/gif" || $_FILES["archivos"]["type"][$i]=="image/jpeg" || $_FILES["archivos"]["type"][$i]=="image/x-png" || $_FILES["archivos"]["type"][$i]=="image/pjpeg" || $_FILES["archivos"]["type"][$i]=="image/tif" || $_FILES["archivos"]["type"][$i]=="image/tiff")
			{	
        		
			   //exif_imagetype ---> determina el tipo de imagen 
                $imaginf= getimagesize($_FILES["archivos"]["tmp_name"][$i]);
			
				if ($imaginf["mime"] != "image/gif" && $imaginf["mime"] != "image/jpeg" && $imaginf["mime"] != "image/png"  && $imaginf["mime"] != "image/jpg"  && $imaginf["mime"] != "image/pjpeg"  && $imaginf["mime"] != "image/x-png"  && $imaginf["mime"] != "image/tif"  && $imaginf["mime"] != "image/tiff")
				{
			      array_push($errores, 'El tipo de archivo <strong>NO </strong>corresponde a la extensión');
				}
			}
			else if($_FILES["archivos"]["type"][$i]!="application/pdf" && $_FILES["archivos"]["type"][$i]!="application/msword" &&  $_FILES["archivos"]["type"][$i]!="application/vnd.ms-excel" && $_FILES["archivos"]["type"][$i]!='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' && $_FILES["archivos"]["type"][$i]!='application/vnd.openxmlformats-officedocument.wordprocessingml.document')
			{
			          array_push($errores, 'Tipo de archivo <strong>No </strong>permitido');
			}

			/* Valida que el tipo de archivo este en el listado de los archivos permitidos */
			$centinela_tipo_archivo = 0;
			foreach ($tipo_archivo_permitido as $tipo_archivo) {
				if ($archivo_tipo == $tipo_archivo) {
					$centinela_tipo_archivo = 1;
				}
			}
			if ($centinela_tipo_archivo == 0) {
				array_push($errores, 'El tipo de archivo de' . $archivo_nombre . '<strong> No</strong> es permitido');
			}

			/* Verifica si se presento algï¿½n error */
			if ($archivo_error != 0) {
				array_push($errores, 'Se presentó un error al cargar el archivo <strong>' . $archivo_nombre.'</strong>');
			}
		}
	}
}
/* Fin de la verificaciï¿½n de los archivos cargados */

										/** PROCESAMIENTO DE LA INFORMACION **/

/* 
Si hay varias peticiones al mimos tiempo la siguiente variable cambia true para que guarde varias peticiones con la misma informacion
*/                                        
$multple_peticion = false;
/* Si no se presentaron errores en el ingreso de la informaciï¿½n se copian los
 * documentos adjuntos y se ingresa la informaciï¿½n en la base de datos */
$numeroErrores = count($errores);
$multple_peticion = false;


if ($numeroErrores == 0 && $enviar == 'ok') {
    
    if($_SESSION['captcha'] != ''){
        
        //$db->StartTrans();
        $_SESSION['captcha'] = '';

        /* si el nï¿½mero de identifiaciï¿½n esta vacio se NULL en la base de datos */
        if ($numero_identificacion == '') {
            $numero_identificacion_insert = 'NULL';
        } else {
            /* si el tipo de documento de identificaciï¿½n es nit entonces se le adiciona el digito de verificacion */

            if($tipo_identificacion==$nit){
                $numero_identificacion_insert = $numero_identificacion.'-'.$digito_verificacion;
            }
            else{
                $numero_identificacion_insert = $numero_identificacion;
            }
        }

        /* Si el nombre del solicitante esta vacio se asigna 'Anónimo' en la base de datos */
        if ($nombre == '') {
            $nombre_insert = 'Anónimo';
        } else {
            $nombre_insert = $nombre;
        }

        /* Crea la sentencia de inserciï¿½n de informaciï¿½n del solicitante en la base de datos */
        
        $sql_insert_solicitante = 'insert into pqr_solicitante (' .
        'solicitante_nombre,' .
        'tipo_identificacion_id,' .
        'solicitante_identificacion,' .
        'solicitante_email,' .
        'solicitante_telefono_1,' .
        'solicitante_telefono_2,' .
        'solicitante_direccion,' .
        'idusuario,' .
        'creacion,' .
        'modificacion) ' .
        'values ("' . $nombre_insert . '",
            ' . $tipo_identificacion . ',
            "' . $numero_identificacion_insert . '",
            "' . $email . '",
            "' . $telefono . '",
            "' . $celular . '",
            "' . $direccion . '",
            "' . $idusuario .'",
            "' . $timestamp . '",
            "' . $timestamp . '")';
    //echo $sql_insert_solicitante;
        /* Ejecuta la sentencia de inserciï¿½n */
        
        if ($db->Execute($sql_insert_solicitante) == false) {
            $continuar = 'no';
        }
        
        $inser_id_solicitante = $db->Insert_ID();

        /* Consulta el identificador del solicitante insertado*/
        if ($continuar == 'ok') {
            $sql_consulta_solicitante_id = 'select max(solicitante_id) as solicitante_id ' .
            'from pqr_solicitante ' .
            'where creacion="' . $timestamp . '"';
            $resultado_solicitante_id = $db->Execute($sql_consulta_solicitante_id);
            if ($resultado_solicitante_id->NumRows() > 0) {
                $solicitante_id = $resultado_solicitante_id->fields['solicitante_id'];
            } else {
                $continuar = 'no';
            }
        }
		
		
		
        /* Crea la sentencia de inserciï¿½n de la solicitud en la base de datos*/
        if ($continuar == 'ok') {
            $sql_insert_solicitud = '
                insert into pqr_solicitud (
                    originador_id,
                    region_id,
                    medio_id,
                    solicitante_id,
                    solicitud_descripcion,
                    solicitud_hash,
                    creacion,
                    ip)
                values (
                    ' . $tipo_persona . ',
                    ' . $region . ',
                    ' . $medio_recepcion . ',
                    ' . $solicitante_id . ',
                    "' . $solicitud . '",
                    "' . $hash . '",
                    "' . $timestamp . '",
                    "' . $_SERVER['REMOTE_ADDR'] . '")';
            
            /* Ejecuta la sentencia de inserciï¿½n */
            
            if ($db->Execute($sql_insert_solicitud) == false) {
                $continuar = 'no';
            }
                
            $inser_id_solicitud = $db->Insert_ID();
        }
		
        /* Consulta el identificador de la solicitud insertada */
        if ($continuar == 'ok') {
            $sql_consulta_solicitud_id = 'select solicitud_id ' .
            'from pqr_solicitud ' .
            'where solicitud_hash="' . $hash . '"';
            $resultado_solicitud_id = $db->Execute($sql_consulta_solicitud_id);
            if ($resultado_solicitud_id->NumRows() > 0) {
                $solicitud_id = $resultado_solicitud_id->fields['solicitud_id'];
            } else {
                $continuar = 'no';
            }
        }

		
        /* Consulta los parametros del tipo de solicitud indicados*/
        if ($continuar == 'ok') {
            $sql_consulta_info_tipo = 'select tipo_favorable,tipo_plazo_total,tipo_plazo_alerta ' .
                                      'from pqr_tipo ' .
                                      'where eliminado=0 and tipo_id=' . $tipo_solicitud;

            $resultado_consulta_info_tipo = $db->Execute($sql_consulta_info_tipo);
            if ($resultado_consulta_info_tipo->NumRows() > 0) {
                $tipo_favorable = $resultado_consulta_info_tipo->fields['tipo_favorable'];
                $tipo_plazo_total = $resultado_consulta_info_tipo->fields['tipo_plazo_total'];
                $tipo_plazo_alerta = $resultado_consulta_info_tipo->fields['tipo_plazo_alerta'];
            } else {
                $continuar = 'no';
            }
        }
        
        
        // Nuevo para obtener el valor del id a quien se le asignaba la solicitud, ya que solo se asignaba a Atención al ciudadano
        if(isset($_POST['dependencia_n1'])){
          $dependencia_seleccionada=$_POST['dependencia_n1'];

        }

        if(isset($_POST['dependencia_n2'])){
          $dependencia_seleccionada=$_POST['dependencia_n2'];

        }
        
        if(isset($_POST['dependencia_n3'])){
           $dependencia_seleccionada=$_POST['dependencia_n3'];

        }

        if(isset($_POST['dependencia_n4'])){
           $dependencia_seleccionada=$_POST['dependencia_n4'];

        }

        if(isset($_POST['dependencia_n5'])){
          $dependencia_seleccionada=$_POST['dependencia_n5'];

        }
        // fin parte nueva captura valor id dependencia responsable.
        
        
        /*
        if(!isset($dependencia_seleccionada)){
            $dependencia_seleccionada = 6;
        }
        */


        /* Si el asunto de la solicitud esta vacio entonces se asigna el valor de asunto NO CLASIFICADO con un valor de 22 en la base de datos */
        if ($asunto <= 0) {
            $asunto_insert = 22;
        } else {
            $asunto_insert = $asunto;
        }

        /* Si la dependencia de la solicitud esta vacia entonces se asigna el valor por defecto  */
        //if ($dependencia <= 0) {
        if ($administrador_pqr != 'ok' or $gestor_pqr != 'ok') {
            $dependencia_insert = _PQR_ATENCION;
        } else {
            //$dependencia_insert = $dependencia;
            $dependencia_insert = $dependencia_seleccionada;
        }
        
        
        if ($continuar == 'ok') {
            /* Crea la sentencia de inserción de informacion de la transacciï¿½n en la base de datos */
            $sql_insert_transaccion = 'insert into pqr_transaccion (
                    transaccion_resumen,
                    solicitud_id,
                    asunto_id,
                    estado_id,
                    tipo_id,
                    tipo_favorable,
                    tipo_plazo_total,
                    tipo_plazo_alerta,
                    dependencia_id,
                    creacion)
                values (
                    "' . $resumen . '",
                    ' . $solicitud_id . ',
                    ' . $asunto_insert . ',
                    ' . $estado . ',
                    ' . $tipo_solicitud . ',
                    ' . $tipo_favorable . ',
                    ' . $tipo_plazo_total . ',
                    ' . $tipo_plazo_alerta . ',
                    ' . $dependencia_insert . ',
                    "' . $timestamp . '")';
            
            /* Ejecuta la sentencia de inserciï¿½n */
            if ($db->Execute($sql_insert_transaccion) == false) {
                $contiuar = 'no';
            }
            
            $inser_id_transaccion = $db->Insert_ID();
            
        }

        //crear_pdf($hash);         SE COMENTARIO LA FUNCION QUE CREABA EL PDF DE IMPRESION
        //crear_pdf($hash);
        
        
                
        /* Se suben los documentos anexos al servidor */
        /* Creaciï¿½n del directorio donde se almacenarï¿½n los documentos de esta solicitud */
        
        if($continuar=='ok'){
            
            $uploaddir = _DIRRECURSOS_USER ._RECURSOSDIRPQR ."/". $solicitud_id;
            
            //echo "<br/>";
            //echo "RUTA Archivo crear variable:".$uploaddir."<br/>";
            
            if (file_exists($uploaddir)) {
            
                //echo "Existe carpeta";
                $uploaddir.='/'. $transaccion_id;
                
                
                
            }
            else{
                
                $verificacion = true;
                
                
                if(!mkdir($uploaddir, 0750)){  // 0755 Se cambiaron los permisos
                    $continuar = 'no';
                    $verificacion = false;
                    array_push($errores, 'En este momento no se puede guardar la solicitud, porfavor comuniquese con el administrador');
                    
                    /* Si no se puede subir los archivos por que la carpeta se llena se nesecita borrar la informacion que anteriormente se guardo.*/
                    
                    
                    $sql_delete_transaccion = 'DELETE FROM pqr_transaccion where transaccion_id = ' . $inser_id_transaccion;
                    $sql_delete_solicitud   = 'DELETE FROM pqr_solicitud where solicitud_id = ' . $inser_id_solicitud;
                    $sql_delete_solicitante = 'DELETE FROM pqr_solicitante where solicitante_id = ' . $inser_id_solicitante;

                    $db->Execute($sql_delete_transaccion);
                    $db->Execute($sql_delete_solicitud);
                    $db->Execute($sql_delete_solicitante);
                    
                    
                    /* Enviamos un correo avisando de la falla del sistema a gerencia@micrositios.net*/
                    
                    
                    $mensaje_administrador='El sistema intento guardar el siguiente pqr pero no fue posible por un error en el sistema)<br>
                            creado el '.$timestamp.' con la siguiente informaci&oacute;n: '.$eof.$eof.
                            '<br><strong>Nombre:						</strong>'.$nombre.$eof.
                            '<br><strong>Tipo de documento:			</strong>'.$nombre_tipo_identificacion.$eof.
                            '<br><strong>N&uacute;mero documento:	</strong>'.$numero_identificacion.$eof.
                            '<br><strong>Direcci&oacute;n:			</strong>'.$direccion.$eof.
                            '<br><strong>Tel&eacute;fono:			</strong>'.$telefono.$eof.
                            '<br><strong>Celular:					</strong>'.$celular.$eof.
                            '<br><strong>Correo electr&oacute;nico:	</strong>'.$email.$eof.
                            '<br><strong>Ubicaci&oacute;n:			</strong>'.$miga_ubicacion.$eof.
                            '<br><strong>Medio de recepci&oacute;n:	</strong>'.$nombre_medio_recepcion.$eof.
                            '<br><strong>Tipo de solicitud:			</strong>'.$nombre_tipo_solicitud.$eof.
                            '<br><strong>Dependencia:				</strong>'.$miga_dependencia.$eof.
                            '<br><strong>Asunto:						</strong>'.$miga_asunto.$eof.
                            '<br><strong>Solicitud:					</strong>'.$solicitud.$eof.
                            $resumen_correo.$eof.
                            $documentos_email.$eof.$eof.

                    /* Se le entrega al usuario el cï¿½digo hash de la solicitud para consultar el estado */

                    //$msg_consulta_hash	= 'El c&oacute;digo de consulta de su solicitud es <strong><h3>'.$hash.'</h3></strong><br/>El numero consecutivo es:<strong><h3>'.$solicitud_id.'</h3></strong>';

                   
                            

                    /* Nuevo para que acepte etiquetas HTML en el cuerpo del mensaje. */		
                    
                    
                    $bHayFicheros = 0; 
                    $sAdjuntos = ""; 
                    
                    $mail = new PHPMailer();
                    //$mail->SMTPDebug  = 2;
                    $mail->From = 'contactenos@ejercito.mil.co';
                    $mail->FromName = "Contactenos";
                    $mail->AddAddress(_PQR_CORREO);
                    $mail->AddAddress('creina@micrositios.com');
                    
                    for ($count = 0; $count < count($_FILES["archivos"]["name"]); $count++)
                    {
                        if ($_FILES["archivos"]["size"][$count] > 0)
                        {
                                /*$sAdjuntos .= "\n\n----_Separador-de-mensajes_--\n";
                                $sAdjuntos .= "Content-type: ".$vAdjunto["type"].";name=\"".$_FILES["archivos"]["name"][$count]."\"\n";;
                                $sAdjuntos .= "Content-Transfer-Encoding: BASE64\n";
                                $sAdjuntos .= "Content-disposition: attachment;filename=\"".$_FILES["archivos"]["name"][$count]."\"\n\n";

                                $oFichero = fopen($_FILES["archivos"]["tmp_name"][$count] , 'r');
                                $sContenido = fread($oFichero, filesize($_FILES["archivos"]["tmp_name"][$count]));
                                $sAdjuntos .= chunk_split(base64_encode($sContenido));
                                fclose($oFichero);*/
                                
                                $mail->AddAttachment($_FILES['archivos']['tmp_name'][$count], $_FILES['archivos']['name'][$count]);
                                
                        }
                    }
                    
                    $mail->IsHTML(true);
                    $mail->Subject = 'Error de inserccion del pqr';
                    $mail->Body = $mensaje_administrador;
                    $mail->Send();
                
                    $mail = new PHPMailer();
                    
                     /* Crea el mensaje que se enviara al usuario*/
                    $mensaje_usuario='La solicitud ingresada por ustede no fue guardada en el sistma, sin enbargo la informacion fue enviada por correo al administrador, sin enbargo comuniquese con administrador del sitio<br>'.$eof.$eof.
                            '<br><strong>Tipo de solicitud:</strong>  '.$nombre_tipo_solicitud.$eof.
                            '<br><strong>Solicitud:</strong>          '.$solicitud.$eof.
                            $documentos_email.$eof.$eof.
                            '<br>Gracias por comunicarse con nosotros'.$eof.$eof;
                    
                    //$mail->SMTPDebug  = 2;
                    $mail->From = 'contactenos@ejercito.mil.co';
                    $mail->FromName = "Contactenos";
                    $mail->AddAddress($email);
                    $mail->AddAddress('creina@micrositios.com');
                    $mail->IsHTML(true);
                    $mail->Subject = 'Solicitud en la pagina de ejercito';
                    $mail->Body = $mensaje_usuario;
                    $mail->Send();
                    
                    
                    
                    $error_envio_informacion = true;
                    /* Envia el correo al responsable de gestionar el sistema de PQR*/
                    //if(Funciones::microsmail(_PQR_CORREO,$asunto_correo_admin,$mensaje_administrador,_PQR_CORREO)){     Se cambio para que enviara con la funcion mail
                    //mail($sPara, $sAsunto, $sTexto, $sCabeceras);
                    
                }
                
                
                //verificar carpeta

              
                
            }
           
            if($verificacion){
                
                
                /* Se copian los archivos al directorio asignado a la solicitud */
                for ($i = 0; $i < $total_archivos; $i++) {
                    /* Si se indico algï¿½n archivo se copian al directorio asignado */
                        if($archivo_nombre !=''){

                    //echo "VALOR DIFERENTE A 1";			

                                $archivo_nuevo=substr(md5(rand()), 15, 30);
                        $extension = $_FILES["archivos"]["type"][$i]; 


                //$mime_type = $result_array['mime']; 
                        switch($extension) { 
                        case "image/jpeg": 
                                $extension="jpeg";
                                break; 
                        case "image/x-png": 
                                $extension="png";
                                break; 
                        case "image/pjpeg": 
                                $extension="jpg";
                                break; 
                        case "image/tif": 
                                $extension="tif";
                                break; 
                        case "image/tiff": 
                                $extension="tif";
                                break;
                        case "image/gif": 
                                $extension="gif";
                                break; 
                        case "image/png": 
                                $extension="png";
                                break; 
                        case "image/jpg": 
                                $extension="jpg";
                                break;
                        case "application/pdf": 
                                $extension="pdf";
                                break;

                        case "application/msword": 
                                $extension="doc";
                                break;
                        case "application/vnd.ms-excel": 
                                $extension="xls";
                                break;
                        case "application/msword": 
                                $extension="docx";
                                break;
                        case "application/vnd.ms-excel": 
                                $extension="xlsx";
                                break;
                    case "application/vnd.openxmlformats-officedocument.wordprocessingml.document": 
                                $extension="docx";
                                break;
                                case "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":
                                $extension="xlsx";
                                break;

                            default: 
                                $extension="txt";
                        } 

                        $archivo_nuevo=substr(md5(rand()), 15, 30).'.'.$extension;
                        $uploadfile = $uploaddir . '/' . $archivo_nuevo;//ECHO $uploadfile;


                        if (move_uploaded_file($_FILES["archivos"]["tmp_name"][$i], $uploadfile ))
                        {    

                            chmod($uploadfile, 0440);  // 0755 Se cambiaron los permisos 0644
                            array_push($documento_cargado,$archivo_nuevo);

                        }
                        else{
                            $continuar = 'no';
                            array_push($errores, 'NO SUBIO');
                        }
                        /* Hace la inserciï¿½n de los registros que relacionan los documentos con la transacciï¿½n */

                        if($continuar=='ok'){
                            /* Crea la sentencia de inserciï¿½n de informacion del documento en la base de datos */
                            $sql_insert_documento = 'insert into pqr_documento (
                                    tipo_documento_id, ' .
                                    'transaccion_id, ' .
                                    'documento_nombre, ' .
                                    'creacion, ' .
                                    'modificacion)
                                values (
                                    ' . $tipo_documento . ',
                                    ' . $inser_id_transaccion . ',
                                    "' . $archivo_nuevo . '",
                                    "' . $timestamp . '",
                                    "' . $timestamp . '"
                                )';

                            /* Ejecuta la sentencia de inserciï¿½n */
                            if ($db->Execute($sql_insert_documento) == false) {
                                $contiuar = 'no';
                            }
                        }   
                        
                        

                    }
                }
            }
            
			 
            
        }
        
        
        
        /* Consulta el identificador de la transacciï¿½n creada */
        if ($continuar == 'ok')
        {
            $sql_consulta_transaccion_id = 'select max(transaccion_id) as transaccion_id ' .
            'from pqr_transaccion ' .
            'where creacion="' . $timestamp . '"';
            $resultado_transaccion_id = $db->Execute($sql_consulta_transaccion_id);
            if ($resultado_transaccion_id->NumRows() > 0)
            {
                $transaccion_id = $resultado_transaccion_id->fields['transaccion_id'];

                /* Actualiza el la transacciï¿½n actual en la base de datos */
                $qUpdateState	= sprintf("
                                    UPDATE %s
                                    SET estado_actual = %s
                                    WHERE solicitud_id = %s
                                    ",
                                    _TBL_PQR_SOLICITUD,
                                    $transaccion_id,
                                    $solicitud_id);
                
              
                /* Ejecuta la actualizaciï¿½n */
                $rUpdateState	= $db->Execute($qUpdateState);
       
                if(!$qUpdateState)
                {
                    $continuar = 'no';
                }
            }
            else
            {
                $continuar = 'no';
            }
        }
        
		
		
		
        //echo "VARIABLE PARA CREAR DOCUMENTO::".$continuar."<br />";
        
        /* Envia el correo con la informaciï¿½n de la solicitud */

        if($continuar == 'ok'){

            /* define el salto de lï¿½nea */
            $eof='<br>';

            /* Verifica si el resumen es igual a la solicitud no envï¿½a el resumen al correo */
            if($resumen==$solicitud){
                $resumen_correo	= '';
            }
            else{
                $resumen_correo	= '<strong>Resumen:</strong> '.$resumen.$eof;
            }

            /* Define el asunto del mensaje para el solicitante*/
            $asunto_correo			= html_entity_decode('Nueva solicitud registrada en el sistema de Atenci&oacute;n al Ciudadano',ENT_NOQUOTES);

            /* Define el asunto del mensaje para el administrador*/
            $asunto_correo_admin	= html_entity_decode('PQR No. '.$solicitud_id.' ('.$nombre_tipo_solicitud.') creado el '.$timestamp,ENT_NOQUOTES);

            /* Crea el listado de documentos */
            if(count($documento_cargado)>0)
            {
                $documentos_email		= '<strong>Documentos:</strong> '.$eof;
                foreach($documento_cargado as $documento)
                {
                    $documentos_email	.= '- <a href="'._URL._DIRRECURSOS_USER.'pqr2/'.$solicitud_id.'/'.$transaccion_id.'/'.$documento.'">'.$documento.'</a>'.$eof;
                }
            }
            else
            {
                $documentos_email		= '';
            }
            /* Crea el link para acceder a la pagina de gestiï¿½n de la solicitud */
            $link_gestion_solicitud		=	sprintf(
                                            '<a href="%s/index.php?idcategoria=%s&solicitud_id=%s">click aquí</a>',
                                            _URL,
                                            _PQR_GESTION,
                                            $solicitud_id);

            /* Crea el mensaje que se enviara al adiminstrador del sistema*/
            $mensaje_administrador='Solicitud No.    '.$solicitud_id.' ('.$nombre_tipo_solicitud.') creado el '.$timestamp.' con la siguiente informaci&oacute;n: '.$eof.$eof.
                    '<strong>Nombre:						</strong>'.$nombre.$eof.
                    '<strong>Tipo de documento:			</strong>'.$nombre_tipo_identificacion.$eof.
                    '<strong>N&uacute;mero documento:	</strong>'.$numero_identificacion.$eof.
                    '<strong>Direcci&oacute;n:			</strong>'.$direccion.$eof.
                    '<strong>Tel&eacute;fono:			</strong>'.$telefono.$eof.
                    '<strong>Celular:					</strong>'.$celular.$eof.
                    '<strong>Correo electr&oacute;nico:	</strong>'.$email.$eof.
                    '<strong>Ubicaci&oacute;n:			</strong>'.$miga_ubicacion.$eof.
                    '<strong>Medio de recepci&oacute;n:	</strong>'.$nombre_medio_recepcion.$eof.
                    '<strong>Tipo de solicitud:			</strong>'.$nombre_tipo_solicitud.$eof.
                    '<strong>Dependencia:				</strong>'.$miga_dependencia.$eof.
                    '<strong>Asunto:						</strong>'.$miga_asunto.$eof.
                    '<strong>Solicitud:					</strong>'.$solicitud.$eof.
                    $resumen_correo.$eof.
                    $documentos_email.$eof.$eof.
                    'Para gestionar esta solicitud haga '.$link_gestion_solicitud;

            /* Se le entrega al usuario el cï¿½digo hash de la solicitud para consultar el estado */

            $msg_consulta_hash	= 'El c&oacute;digo de consulta de su solicitud es <strong><h3>'.$hash.'</h3></strong><br/>El numero consecutivo es:<strong><h3>'.$solicitud_id.'</h3></strong>';

            /* Crea el mensaje que se enviara al usuario*/
            $mensaje_usuario='Solicitud No. '.$solicitud_id.' ('.$nombre_tipo_solicitud.') creado el '.$timestamp.' en el sistema de atención al ciudadano del Ejército Nacional de Colombia'.$eof.$eof.
                    '<strong>Tipo de solicitud:</strong>  '.$nombre_tipo_solicitud.$eof.
                    '<strong>Solicitud:</strong>          '.$solicitud.$eof.
                    $documentos_email.$eof.$eof.
                    'Su solicitud ha sido recibida y esta siendo tramitada'.$eof.
                    $msg_consulta_hash.
                    'Gracias por comunicarse con nosotros'.$eof.$eof.
                    'Para consultar el estado de su solicitud haga <a href="'._URL.'?idcategoria='._INICIO_PQR.'&ver_solicitudes=1&consulta_hash='.$hash.'">clic aqu&iacute;</a>';
                    
            /* Nuevo para que acepte etiquetas HTML en el cuerpo del mensaje. */		
            $cabezote  = "From: Atención al Ciudadano <contactenos@ejercito.mil.co>\r\n";
            $cabezote .= "MIME-Version: 1.0\r\n"; 
            $cabezote .= "Content-type: text/html; charset=iso-8859-1\r\n";
            $cabezote .= "Content-Transfer-Encoding: 8bit"; 
            
            
            /* Envia el correo al responsable de gestionar el sistema de PQR*/
            //if(Funciones::microsmail(_PQR_CORREO,$asunto_correo_admin,$mensaje_administrador,_PQR_CORREO)){     Se cambio para que enviara con la funcion mail
             if(mail(_PQR_CORREO,$asunto_correo_admin,$mensaje_administrador,$cabezote)){
                if($email!='')
                {
                    /* si el usuario registro un correo electrï¿½nico le envï¿½a un correo con la informaciï¿½n de la solicitud */
                    //Funciones::microsmail($email,$asunto_correo,$mensaje_usuario,_PQR_CORREO);     SE cambio para que enviara con la funcion mail
                    mail($email,$asunto_correo,$mensaje_usuario,$cabezote);
                }
            }
        }
		
		
		

        /* Crea el mensaje de respuesta para el usuario segï¿½n el resultado de la transacciï¿½n */
        if ($continuar == 'ok')
        {
            $msg_respuesta = 'Su '.$nombre_tipo_solicitud.' se registro satisfactoriamente<br>'.$msg_consulta_hash;
        }
        else
        {
            $msg_respuesta = 'Se presento un error, por favor intente m&aacute;s tarde';
        }
        

        $rollback = ($continuar == 'ok') ? true : false;
        //$esError = $db->CompleteTrans(true);
        
    }else
        $error_envio_informacion = true;
}
else{
	$continuar='no';
}
        



							/** PASO DE VARIABLES A LA PLANTILLA DE SMARTY **/
/* Se crea una nueva instancia de Smarty */
$smarty = new Smarty_Plantilla();

/* Asigna a una variable la ruta de la hoja de estilos */
$smarty->assign('DIRCSS'	, _DIRCSS);

/* Asigna a una variable la ruta de los archivos de funciones javascript */
$smarty->assign('DIRJS'		, _DIRJS);

/* Asigna el contenido de los titulos, textos y etiquetas */

//if(!$multple_peticion || (count($_POST) != 0) ){
    $smarty->assign('lb_titulo_formulario'				,'SISTEMA DE PETICIONES, QUEJAS Y RECLAMOS');
    $smarty->assign('lb_titulo_datos_personales'		,'Datos personales');
    $smarty->assign('lb_titulo_info_solicitud'			,'Informaci&oacute;n de la solicitud');
    $smarty->assign('lb_titulo_confirmacion'			,'Confirme su solicitud');

    $smarty->assign('lb_introduccion_formulario'		, _ROT_EDICION);

    $smarty->assign('lb_nombre'							,'Nombre completo');
    $smarty->assign('lb_tipo_persona'					,'Tipo de persona');
    $smarty->assign('lb_tipo_identificacion'			,'Tipo de documento');
    $smarty->assign('lb_numero_identificacion'			,'N&uacute;mero documento');
    $smarty->assign('lb_direccion'						,'Direcci&oacute;n');
    $smarty->assign('lb_telefono'						,'Tel&eacute;fono');
    $smarty->assign('lb_celular'						,'Celular');
    $smarty->assign('lb_email'							,'Correo electr&oacute;nico');
    $smarty->assign('lb_ubicacion'						,'Ubicaci&oacute;n');

    $smarty->assign('lb_estado'							,'Estado de la solicitud');
    $smarty->assign('lb_medio_recepcion'				,'Medio de recepci&oacute;n');
    $smarty->assign('lb_tipo_solicitud'					,'Tipo de solicitud');
    $smarty->assign('lb_dependencia'					,'Dependencia');
    $smarty->assign('lb_asunto'							,'Asunto');
    $smarty->assign('lb_solicitud'						,'Solicitud');
    $smarty->assign('lb_resumen'						,'Resumen');

    $smarty->assign('lb_lista_documentos'				,'Documentos anexos');
    $smarty->assign('lb_archivos'						,'Archivos a Subir (Opcional)');
    $smarty->assign('lb_lk_subir_mas'					,'Subir otro archivo');
    $smarty->assign('lb_adjuntar_advertencia'			,'El tama&ntilde;o m&aacute;ximo para cada archivo es de '.$archivo_max_size_hr);
    $smarty->assign('lb_advertencia_campo_solicitud'	,'Su solicitud puede contener m&aacute;ximo 65536 caracteres');

    $smarty->assign('lb_confirmacion_codigo'			,'Escriba el c&oacute;digo aqu&iacute;');

    $smarty->assign('btn_lb_enviar'						,'Enviar solicitud');

    /* Asigna las opciones de las listas de selecciÃ³n */
    $smarty->assign('select_tipo_persona'				,$select_originador);
    $smarty->assign('select_tipo_identificacion'		,$select_tipo_identificacion);
    $smarty->assign('select_tipo_solicitud'				,$select_tipo_solicitud);
    $smarty->assign('select_medio_recepcion'			,$select_medio_recepcion);
    $smarty->assign('select_estado'						,$select_estado);

    /* Asigna los arreglos con los select dependientes */
    $smarty->assign('select_region'						,$select_region);
    $smarty->assign('select_asunto'						,$select_asunto);
    $smarty->assign('select_dependencia'				,$select_dependencia);

    /* Asigna los links que no son manejados por el porta */
    $smarty->assign('link_menu_administracion'			,$link_menu_administracion);

    /* Valores de los campos del formulario */
    $smarty->assign('nombre'							,$nombre);
    $smarty->assign('region'							,$region);
    $smarty->assign('asunto'							,$asunto);
    if(isset ($asunto_nombre) && (strlen($asunto_nombre) > 40))
    {
        $smarty->assign('estilo_nombre'						,'style="font-size: 0.8em"');
    }
    $smarty->assign('asunto_nombre'						,$asunto_nombre);
    $smarty->assign('tipo_persona'						,$tipo_persona);
    $smarty->assign('tipo_identificacion'				,$tipo_identificacion);
    $smarty->assign('numero_identificacion'				,$numero_identificacion);
    $smarty->assign('digito_verificacion'				,$digito_verificacion);
    $smarty->assign('digito_verificacion_visibility'	,$digito_verificacion_visibility);
    $smarty->assign('direccion'							,$direccion);
    $smarty->assign('telefono'							,$telefono);
    $smarty->assign('celular'							,$celular);
    $smarty->assign('email'								,$email);
    $smarty->assign('estado'							,$estado);
    $smarty->assign('medio_recepcion'					,$medio_recepcion);
    $smarty->assign('tipo_solicitud'					,$tipo_solicitud);
    $smarty->assign('dependencia'						,$dependencia);
    $smarty->assign('solicitud'							,$solicitud);
    $smarty->assign('resumen'							,$resumen);

    /* Resultado de la validaciï¿½n */
    $smarty->assign('errores'							,$errores);
    $smarty->assign('numeroErrores'						,$numeroErrores);
    $smarty->assign('continuar'							,$continuar);

    /* Resultado de la inserciï¿½n */
    $smarty->assign('msg_respuesta'						,$msg_respuesta);
    $smarty->assign('imprimir'							,_URL.'index.php?idcategoria='.$idcategoria.'&print');

    /* Cï¿½digo html de las solicitudes */
    $smarty->assign('solicitudes_html'					,$solicitudes_html);
    $smarty->assign('esta_pagina'						,_URL.'index.php?idcategoria='.$idcategoria);
    $smarty->assign('ver_solicitudes'					,$ver_solicitudes);

    /* Asigna los valores de las banderas */
    $smarty->assign('flg_enviar'						,$enviar);
    $smarty->assign('flg_originador_visible'			,$flg_originador_visible);
    $smarty->assign('flg_estado'						,$flg_estado);
    $smarty->assign('flg_medio_recepcion'				,$flg_medio_recepcion);
    $smarty->assign('flg_resumen'						,$flg_resumen);
    $smarty->assign('flg_hash'							,$flg_hash);
    $smarty->assign('flg_disabled_nombre'				,$flg_disabled_nombre);
    $smarty->assign('flg_disabled_direccion'			,$flg_disabled_direccion);
    $smarty->assign('flg_disabled_telefono'				,$flg_disabled_telefono);
    $smarty->assign('flg_disabled_email'				,$flg_disabled_email);
    $smarty->assign('flg_disabled_select_asunto'		,$flg_disabled_select_asunto);
    $smarty->assign('flg_usuario_registrado'			,$usuario_registrado);
    $smarty->assign('flg_administrador_pqr'				,$administrador_pqr);
    $smarty->assign('flg_digitador_pqr'					,$digitador_pqr);
    $smarty->assign('flg_gestor_pqr'					,$gestor_pqr);/*VARIABLE QUE SE LE ASIGNA A SMARTY PARA EL GESTOR***********FP*/
    $smarty->assign('flg_registrado'					,$flg_registrado);
    //$smarty->assign('texto_ayuda'						,'Aqu&iacute; puede agregar los archivos que va a usar como soporte para la solicitud. Puede agregar archivos de Microsoft Office (Word, Excel), Acrobat Reader (PDF), im&aacute;genes (JPG, PNG), archivos de video (AVI, Quicktime) o archivos de FLASH (SWF).');
    $smarty->assign('texto_ayuda'						,'Aqu&iacute; puede agregar los archivos que va a usar como soporte para la solicitud. Puede agregar archivos de Acrobat Reader (PDF), im&aacute;genes (JPG, PNG,GIF).');
    $smarty->assign('flg_nueva'							,$flg_nueva);
    $smarty->assign('ubicacion_miga'					,$nregion);
    $smarty->assign('iregion'							,$iregion);
    $smarty->assign('mensaje'							,$mensaje);
	


    $smarty->assign('dependencia_usuario'				,$lb_dependencia_usuario);
    /* Se usa fetch cuando esta en el portal */
    
	
	
    if($error_envio_informacion)
        $resultado_pagina=$smarty->fetch('tpl_pqr_crear_solicitud_error.html');
    else
        $resultado_pagina=$smarty->fetch('tpl_pqr_crear_solicitud.html');
/*}else
    $resultado_pagina=$smarty->fetch('tpl_pqr_crear_solicitud_error.html');*/


/* Devuelve el resultado */
return $resultado_pagina;
?>
